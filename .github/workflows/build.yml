# # # name: Build Nextcloud Desktop (Windows EXE)

# # # on:
# # #   push:
# # #     branches: [ main, master ]
# # #   workflow_dispatch:

# # # jobs:
# # #   build-windows:
# # #     runs-on: windows-latest

# # #     steps:
# # #     - name: Checkout source
# # #       uses: actions/checkout@v4
# # #       with:
# # #         submodules: recursive

# # #     - name: Install Qt
# # #       uses: jurplel/install-qt-action@v4
# # #       with:
# # #         version: 6.6.3
# # #         host: windows
# # #         target: desktop
# # #         arch: win64_msvc2019_64
# # #         modules: qtwebengine
# # #         cache: true

# # #     - name: Install dependencies
# # #       run: |
# # #         choco install -y cmake ninja openssl strawberryperl

# # #     - name: Configure
# # #       run: |
# # #         cmake -S . -B build ^
# # #           -G "Ninja" ^
# # #           -DBUILD_WITH_QT6=ON ^
# # #           -DCMAKE_BUILD_TYPE=Release

# # #     - name: Build
# # #       run: |
# # #         cmake --build build

# # #     - name: Package EXE
# # #       run: |
# # #         cmake --build build --target package

# # #     - name: Upload EXE
# # #       uses: actions/upload-artifact@v4
# # #       with:
# # #         name: nextcloud-desktop-windows-exe
# # #         path: build/*.exe


# # name: Build Nextcloud Desktop (Windows EXE)

# # on:
# #   push:
# #     branches: [ main, master ]
# #   workflow_dispatch:

# # jobs:
# #   build-windows:
# #     runs-on: windows-latest

# #     steps:
# #     - name: Checkout source
# #       uses: actions/checkout@v4
# #       with:
# #         submodules: recursive

# #     - name: Install Qt
# #       uses: jurplel/install-qt-action@v4
# #       with:
# #         version: 6.6.3
# #         host: windows
# #         target: desktop
# #         arch: win64_msvc2019_64
# #         modules: qtwebengine
# #         cache: true

# #     - name: Install build tools
# #       run: |
# #         choco install -y cmake ninja openssl strawberryperl git

# #     # ðŸ”§ FIX 1: Install KDE Extra CMake Modules (ECM)
# #     - name: Install KDE ECM
# #       run: |
# #         git clone https://invent.kde.org/frameworks/extra-cmake-modules.git
# #         cd extra-cmake-modules
# #         cmake -S . -B build -G "Ninja" -DCMAKE_INSTALL_PREFIX=C:/ecm
# #         cmake --build build
# #         cmake --install build

# #     # ðŸ”§ FIX 2: PowerShell-safe cmake command (NO ^)
# #     - name: Configure
# #       run: >
# #         cmake -S . -B build
# #         -G "Ninja"
# #         -DBUILD_WITH_QT6=ON
# #         -DCMAKE_BUILD_TYPE=Release
# #         -DCMAKE_PREFIX_PATH="C:/ecm"

# #     - name: Build
# #       run: cmake --build build

# #     - name: Package EXE
# #       run: cmake --build build --target package

# #     - name: Upload EXE
# #       uses: actions/upload-artifact@v4
# #       with:
# #         name: nextcloud-desktop-windows-exe
# #         path: build/*.exe


# name: Build Nextcloud Desktop (Windows EXE)

# on:
#   push:
#     branches: [ main, master ]
#   workflow_dispatch:

# jobs:
#   build-windows:
#     runs-on: windows-latest

#     steps:
#     - name: Checkout source
#       uses: actions/checkout@v4
#       with:
#         submodules: recursive

#     - name: Install Qt (MSVC)
#       uses: jurplel/install-qt-action@v4
#       with:
#         version: 6.6.3
#         host: windows
#         target: desktop
#         arch: win64_msvc2019_64
#         modules: qtwebengine
#         cache: true

#     - name: Install build tools
#       run: |
#         choco install -y cmake ninja git strawberryperl

#     # âœ… Install OpenSSL via vcpkg (MSVC-compatible)
#     - name: Install OpenSSL (vcpkg)
#       run: |
#         git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
#         C:/vcpkg/bootstrap-vcpkg.bat
#         C:/vcpkg/vcpkg install openssl:x64-windows

#     # âœ… Install KDE ECM
#     - name: Install KDE ECM
#       run: |
#         git clone https://invent.kde.org/frameworks/extra-cmake-modules.git
#         cd extra-cmake-modules
#         cmake -S . -B build -G "Ninja" ^
#           -DCMAKE_INSTALL_PREFIX=C:/ecm ^
#           -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
#         cmake --build build
#         cmake --install build

#     # âœ… Configure Nextcloud Desktop
#     - name: Configure
#       run: >
#         cmake -S . -B build
#         -G "Ninja"
#         -DBUILD_WITH_QT6=ON
#         -DCMAKE_BUILD_TYPE=Release
#         -DCMAKE_PREFIX_PATH="C:/ecm"
#         -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

#     - name: Build
#       run: cmake --build build

#     - name: Package EXE
#       run: cmake --build build --target package

#     - name: Upload EXE
#       uses: actions/upload-artifact@v4
#       with:
#         name: nextcloud-desktop-windows-exe
#         path: build/*.exe

name: Build Nextcloud Desktop (Windows MSI)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # Qt (MSVC)
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: 6.6.3
        host: windows
        target: desktop
        arch: win64_msvc2019_64
        modules: qtwebengine
        cache: true

    # Build tools
    - name: Install build tools
      run: |
        choco install -y cmake ninja git strawberryperl wix

    # OpenSSL (MSVC) via vcpkg
    - name: Install OpenSSL (vcpkg)
      run: |
        git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
        C:/vcpkg/bootstrap-vcpkg.bat
        C:/vcpkg/vcpkg install openssl:x64-windows

    # KDE Extra CMake Modules (ECM)
    - name: Install KDE ECM
      run: >
        git clone https://invent.kde.org/frameworks/extra-cmake-modules.git &&
        cd extra-cmake-modules &&
        cmake -S . -B build -G "Ninja"
        -DCMAKE_INSTALL_PREFIX=C:/ecm
        -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake &&
        cmake --build build &&
        cmake --install build

    # Configure Nextcloud Desktop
    - name: Configure
      run: >
        cmake -S . -B build -G "Ninja"
        -DBUILD_WITH_QT6=ON
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_PREFIX_PATH="C:/ecm"
        -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

    # Build
    - name: Build
      run: cmake --build build

    # Package as MSI
    - name: Package MSI Installer
      run: |
        cmake --install build --prefix build/install
        cd build
        cmake -G "Ninja" .
        set CPACK_GENERATOR=WIX
        cmake --build . --target package

    # Upload MSI
    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: nextcloud-desktop-windows-msi
        path: build/*.msi

