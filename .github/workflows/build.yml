# # # # # # # name: Build Nextcloud Desktop (Windows EXE)

# # # # # # # on:
# # # # # # #   push:
# # # # # # #     branches: [ main, master ]
# # # # # # #   workflow_dispatch:

# # # # # # # jobs:
# # # # # # #   build-windows:
# # # # # # #     runs-on: windows-latest

# # # # # # #     steps:
# # # # # # #     - name: Checkout source
# # # # # # #       uses: actions/checkout@v4
# # # # # # #       with:
# # # # # # #         submodules: recursive

# # # # # # #     - name: Install Qt
# # # # # # #       uses: jurplel/install-qt-action@v4
# # # # # # #       with:
# # # # # # #         version: 6.6.3
# # # # # # #         host: windows
# # # # # # #         target: desktop
# # # # # # #         arch: win64_msvc2019_64
# # # # # # #         modules: qtwebengine
# # # # # # #         cache: true

# # # # # # #     - name: Install dependencies
# # # # # # #       run: |
# # # # # # #         choco install -y cmake ninja openssl strawberryperl

# # # # # # #     - name: Configure
# # # # # # #       run: |
# # # # # # #         cmake -S . -B build ^
# # # # # # #           -G "Ninja" ^
# # # # # # #           -DBUILD_WITH_QT6=ON ^
# # # # # # #           -DCMAKE_BUILD_TYPE=Release

# # # # # # #     - name: Build
# # # # # # #       run: |
# # # # # # #         cmake --build build

# # # # # # #     - name: Package EXE
# # # # # # #       run: |
# # # # # # #         cmake --build build --target package

# # # # # # #     - name: Upload EXE
# # # # # # #       uses: actions/upload-artifact@v4
# # # # # # #       with:
# # # # # # #         name: nextcloud-desktop-windows-exe
# # # # # # #         path: build/*.exe


# # # # # # name: Build Nextcloud Desktop (Windows EXE)

# # # # # # on:
# # # # # #   push:
# # # # # #     branches: [ main, master ]
# # # # # #   workflow_dispatch:

# # # # # # jobs:
# # # # # #   build-windows:
# # # # # #     runs-on: windows-latest

# # # # # #     steps:
# # # # # #     - name: Checkout source
# # # # # #       uses: actions/checkout@v4
# # # # # #       with:
# # # # # #         submodules: recursive

# # # # # #     - name: Install Qt
# # # # # #       uses: jurplel/install-qt-action@v4
# # # # # #       with:
# # # # # #         version: 6.6.3
# # # # # #         host: windows
# # # # # #         target: desktop
# # # # # #         arch: win64_msvc2019_64
# # # # # #         modules: qtwebengine
# # # # # #         cache: true

# # # # # #     - name: Install build tools
# # # # # #       run: |
# # # # # #         choco install -y cmake ninja openssl strawberryperl git

# # # # # #     # üîß FIX 1: Install KDE Extra CMake Modules (ECM)
# # # # # #     - name: Install KDE ECM
# # # # # #       run: |
# # # # # #         git clone https://invent.kde.org/frameworks/extra-cmake-modules.git
# # # # # #         cd extra-cmake-modules
# # # # # #         cmake -S . -B build -G "Ninja" -DCMAKE_INSTALL_PREFIX=C:/ecm
# # # # # #         cmake --build build
# # # # # #         cmake --install build

# # # # # #     # üîß FIX 2: PowerShell-safe cmake command (NO ^)
# # # # # #     - name: Configure
# # # # # #       run: >
# # # # # #         cmake -S . -B build
# # # # # #         -G "Ninja"
# # # # # #         -DBUILD_WITH_QT6=ON
# # # # # #         -DCMAKE_BUILD_TYPE=Release
# # # # # #         -DCMAKE_PREFIX_PATH="C:/ecm"

# # # # # #     - name: Build
# # # # # #       run: cmake --build build

# # # # # #     - name: Package EXE
# # # # # #       run: cmake --build build --target package

# # # # # #     - name: Upload EXE
# # # # # #       uses: actions/upload-artifact@v4
# # # # # #       with:
# # # # # #         name: nextcloud-desktop-windows-exe
# # # # # #         path: build/*.exe


# # # # # name: Build Nextcloud Desktop (Windows EXE)

# # # # # on:
# # # # #   push:
# # # # #     branches: [ main, master ]
# # # # #   workflow_dispatch:

# # # # # jobs:
# # # # #   build-windows:
# # # # #     runs-on: windows-latest

# # # # #     steps:
# # # # #     - name: Checkout source
# # # # #       uses: actions/checkout@v4
# # # # #       with:
# # # # #         submodules: recursive

# # # # #     - name: Install Qt (MSVC)
# # # # #       uses: jurplel/install-qt-action@v4
# # # # #       with:
# # # # #         version: 6.6.3
# # # # #         host: windows
# # # # #         target: desktop
# # # # #         arch: win64_msvc2019_64
# # # # #         modules: qtwebengine
# # # # #         cache: true

# # # # #     - name: Install build tools
# # # # #       run: |
# # # # #         choco install -y cmake ninja git strawberryperl

# # # # #     # ‚úÖ Install OpenSSL via vcpkg (MSVC-compatible)
# # # # #     - name: Install OpenSSL (vcpkg)
# # # # #       run: |
# # # # #         git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
# # # # #         C:/vcpkg/bootstrap-vcpkg.bat
# # # # #         C:/vcpkg/vcpkg install openssl:x64-windows

# # # # #     # ‚úÖ Install KDE ECM
# # # # #     - name: Install KDE ECM
# # # # #       run: |
# # # # #         git clone https://invent.kde.org/frameworks/extra-cmake-modules.git
# # # # #         cd extra-cmake-modules
# # # # #         cmake -S . -B build -G "Ninja" ^
# # # # #           -DCMAKE_INSTALL_PREFIX=C:/ecm ^
# # # # #           -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
# # # # #         cmake --build build
# # # # #         cmake --install build

# # # # #     # ‚úÖ Configure Nextcloud Desktop
# # # # #     - name: Configure
# # # # #       run: >
# # # # #         cmake -S . -B build
# # # # #         -G "Ninja"
# # # # #         -DBUILD_WITH_QT6=ON
# # # # #         -DCMAKE_BUILD_TYPE=Release
# # # # #         -DCMAKE_PREFIX_PATH="C:/ecm"
# # # # #         -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

# # # # #     - name: Build
# # # # #       run: cmake --build build

# # # # #     - name: Package EXE
# # # # #       run: cmake --build build --target package

# # # # #     - name: Upload EXE
# # # # #       uses: actions/upload-artifact@v4
# # # # #       with:
# # # # #         name: nextcloud-desktop-windows-exe
# # # # #         path: build/*.exe

# # # # name: Build Nextcloud Desktop (Windows MSI)

# # # # on:
# # # #   push:
# # # #     branches: [ main, master ]
# # # #   workflow_dispatch:

# # # # jobs:
# # # #   build-windows:
# # # #     runs-on: windows-latest

# # # #     steps:
# # # #     - name: Checkout source
# # # #       uses: actions/checkout@v4
# # # #       with:
# # # #         submodules: recursive

# # # #     # Qt (MSVC)
# # # #     - name: Install Qt
# # # #       uses: jurplel/install-qt-action@v4
# # # #       with:
# # # #         version: 6.6.3
# # # #         host: windows
# # # #         target: desktop
# # # #         arch: win64_msvc2019_64
# # # #         modules: qtwebengine
# # # #         cache: true

# # # #     # Build tools
# # # #     - name: Install build tools
# # # #       run: |
# # # #         choco install -y cmake ninja git strawberryperl wix

# # # #     # OpenSSL (MSVC) via vcpkg
# # # #     - name: Install OpenSSL (vcpkg)
# # # #       run: |
# # # #         git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
# # # #         C:/vcpkg/bootstrap-vcpkg.bat
# # # #         C:/vcpkg/vcpkg install openssl:x64-windows

# # # #     # KDE Extra CMake Modules (ECM)
# # # #     - name: Install KDE ECM
# # # #       run: >
# # # #         git clone https://invent.kde.org/frameworks/extra-cmake-modules.git &&
# # # #         cd extra-cmake-modules &&
# # # #         cmake -S . -B build -G "Ninja"
# # # #         -DCMAKE_INSTALL_PREFIX=C:/ecm
# # # #         -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake &&
# # # #         cmake --build build &&
# # # #         cmake --install build

# # # #     # Configure Nextcloud Desktop
# # # #     - name: Configure
# # # #       run: >
# # # #         cmake -S . -B build -G "Ninja"
# # # #         -DBUILD_WITH_QT6=ON
# # # #         -DCMAKE_BUILD_TYPE=Release
# # # #         -DCMAKE_PREFIX_PATH="C:/ecm"
# # # #         -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

# # # #     # Build
# # # #     - name: Build
# # # #       run: cmake --build build

# # # #     # Package as MSI
# # # #     - name: Package MSI Installer
# # # #       run: |
# # # #         cmake --install build --prefix build/install
# # # #         cd build
# # # #         cmake -G "Ninja" .
# # # #         set CPACK_GENERATOR=WIX
# # # #         cmake --build . --target package

# # # #     # Upload MSI
# # # #     - name: Upload MSI
# # # #       uses: actions/upload-artifact@v4
# # # #       with:
# # # #         name: nextcloud-desktop-windows-msi
# # # #         path: build/*.msi


# # # name: Build Nextcloud Desktop (Windows MSI)

# # # on:
# # #   push:
# # #     branches: [ main, master ]
# # #   workflow_dispatch:

# # # jobs:
# # #   build-windows:
# # #     runs-on: windows-latest

# # #     steps:
# # #     # 1Ô∏è‚É£ Checkout source
# # #     - name: Checkout source
# # #       uses: actions/checkout@v4
# # #       with:
# # #         submodules: recursive

# # #     # 2Ô∏è‚É£ Install Qt (MSVC)
# # #     - name: Install Qt
# # #       uses: jurplel/install-qt-action@v4
# # #       with:
# # #         version: 6.6.3
# # #         host: windows
# # #         target: desktop
# # #         arch: win64_msvc2019_64
# # #         modules: qtwebengine
# # #         cache: true

# # #     # 3Ô∏è‚É£ Install build tools + WiX Toolset
# # #     - name: Install build tools
# # #       run: |
# # #         choco install -y cmake ninja git strawberryperl wix-toolset
# # #         refreshenv

# # #     # 4Ô∏è‚É£ Install OpenSSL (MSVC-compatible) via vcpkg
# # #     - name: Install OpenSSL
# # #       run: |
# # #         git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
# # #         C:/vcpkg/bootstrap-vcpkg.bat
# # #         C:/vcpkg/vcpkg install openssl:x64-windows

# # #     # 5Ô∏è‚É£ Install KDE Extra CMake Modules (ECM)
# # #     - name: Install KDE ECM
# # #       run: |
# # #         git clone https://invent.kde.org/frameworks/extra-cmake-modules.git
# # #         cd extra-cmake-modules
# # #         cmake -S . -B build -G "Ninja" ^
# # #           -DCMAKE_INSTALL_PREFIX=C:/ecm ^
# # #           -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
# # #         cmake --build build
# # #         cmake --install build

# # #     # 6Ô∏è‚É£ Configure Nextcloud Desktop
# # #     - name: Configure
# # #       run: |
# # #         cmake -S . -B build -G "Ninja" ^
# # #           -DBUILD_WITH_QT6=ON ^
# # #           -DCMAKE_BUILD_TYPE=Release ^
# # #           -DCMAKE_PREFIX_PATH="C:/ecm" ^
# # #           -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

# # #     # 7Ô∏è‚É£ Build
# # #     - name: Build
# # #       run: cmake --build build

# # #     # 8Ô∏è‚É£ Package MSI using WiX
# # #     - name: Package MSI Installer
# # #       run: |
# # #         cd build
# # #         set CPACK_GENERATOR=WIX
# # #         cmake --build . --target package

# # #     # 9Ô∏è‚É£ Upload MSI artifact
# # #     - name: Upload MSI
# # #       uses: actions/upload-artifact@v4
# # #       with:
# # #         name: nextcloud-desktop-windows-msi
# # #         path: build/*.msi

# # name: Build Nextcloud Desktop (Windows MSI)

# # on:
# #   push:
# #     branches: [ main, master ]
# #   workflow_dispatch:

# # jobs:
# #   build-windows:
# #     runs-on: windows-latest

# #     steps:
# #     # 1Ô∏è‚É£ Checkout source
# #     - name: Checkout source
# #       uses: actions/checkout@v4
# #       with:
# #         submodules: recursive

# #     # 2Ô∏è‚É£ Install Qt (MSVC)
# #     - name: Install Qt
# #       uses: jurplel/install-qt-action@v4
# #       with:
# #         version: 6.6.3
# #         host: windows
# #         target: desktop
# #         arch: win64_msvc2019_64
# #         modules: qtwebengine
# #         cache: true

# #     # 3Ô∏è‚É£ Install build tools + WiX Toolset
# #     - name: Install build tools
# #       run: |
# #         choco install -y cmake ninja git strawberryperl wix-toolset
# #         refreshenv

# #     # 4Ô∏è‚É£ Install OpenSSL via vcpkg (MSVC-compatible)
# #     - name: Install OpenSSL
# #       run: |
# #         git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
# #         C:/vcpkg/bootstrap-vcpkg.bat
# #         C:/vcpkg/vcpkg install openssl:x64-windows

# #     # 5Ô∏è‚É£ Install KDE Extra CMake Modules (ECM)
# #     - name: Install KDE ECM
# #       run: |
# #         git clone https://invent.kde.org/frameworks/extra-cmake-modules.git
# #         cd extra-cmake-modules
# #         cmake -S . -B build -G "Ninja" -DCMAKE_INSTALL_PREFIX=C:/ecm -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
# #         cmake --build build
# #         cmake --install build

# #     # 6Ô∏è‚É£ Configure Nextcloud Desktop
# #     - name: Configure
# #       run: |
# #         cmake -S . -B build -G "Ninja" -DBUILD_WITH_QT6=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="C:/ecm" -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

# #     # 7Ô∏è‚É£ Build
# #     - name: Build
# #       run: cmake --build build

# #     # 8Ô∏è‚É£ Package MSI using WiX
# #     - name: Package MSI Installer
# #       run: |
# #         cd build
# #         set CPACK_GENERATOR=WIX
# #         cmake --build . --target package

# #     # 9Ô∏è‚É£ Upload MSI artifact
# #     - name: Upload MSI
# #       uses: actions/upload-artifact@v4
# #       with:
# #         name: nextcloud-desktop-windows-msi
# #         path: build/*.msi


# name: Build Nextcloud Desktop (Windows MSI)

# on:
#   push:
#     branches: [ main, master ]
#   workflow_dispatch:

# jobs:
#   build-windows:
#     runs-on: windows-latest

#     steps:
#     # 1Ô∏è‚É£ Checkout source
#     - name: Checkout source
#       uses: actions/checkout@v4
#       with:
#         submodules: recursive

#     # 2Ô∏è‚É£ Install Qt (MSVC)
#     - name: Install Qt
#       uses: jurplel/install-qt-action@v4
#       with:
#         version: 6.6.3
#         host: windows
#         target: desktop
#         arch: win64_msvc2019_64
#         modules: qtwebengine
#         cache: true

#     # 3Ô∏è‚É£ Install build tools + WiX + pkg-config
#     - name: Install build tools
#       run: |
#         choco install -y cmake ninja git strawberryperl wix-toolset pkgconfiglite
#         refreshenv

#     # 4Ô∏è‚É£ Install OpenSSL via vcpkg (MSVC-compatible)
#     - name: Install OpenSSL
#       run: |
#         git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
#         C:/vcpkg/bootstrap-vcpkg.bat
#         C:/vcpkg/vcpkg install openssl:x64-windows

#     # 5Ô∏è‚É£ Install KDE Extra CMake Modules (ECM)
#     - name: Install KDE ECM
#       run: |
#         git clone https://invent.kde.org/frameworks/extra-cmake-modules.git
#         cd extra-cmake-modules
#         cmake -S . -B build -G "Ninja" -DCMAKE_INSTALL_PREFIX=C:/ecm -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
#         cmake --build build
#         cmake --install build

#     # 6Ô∏è‚É£ Configure Nextcloud Desktop
#     - name: Configure
#       run: |
#         cmake -S . -B build -G "Ninja" -DBUILD_WITH_QT6=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="C:/ecm" -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

#     # 7Ô∏è‚É£ Build
#     - name: Build
#       run: cmake --build build

#     # 8Ô∏è‚É£ Package MSI using WiX
#     - name: Package MSI Installer
#       run: |
#         cd build
#         set CPACK_GENERATOR=WIX
#         cmake --build . --target package

#     # 9Ô∏è‚É£ Upload MSI artifact
#     - name: Upload MSI
#       uses: actions/upload-artifact@v4
#       with:
#         name: nextcloud-desktop-windows-msi
#         path: build/*.msi

name: Build Nextcloud Desktop (Windows MSI)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    env:
      CRAFT_TARGET: windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
      CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

    steps:
      # 1Ô∏è‚É£ Checkout source
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Cache Craft Dependencies
      - name: Cache Craft Dependencies
        id: cache-craft
        uses: actions/cache@v4
        with:
          path: ${{ env.CRAFT_ROOT }}
          key: ${{ runner.os }}-craft-v2
          restore-keys: |
            ${{ runner.os }}-craft-

      # 3Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 4Ô∏è‚É£ Install required tools
      - name: Install Inkscape & NSIS
        shell: pwsh
        run: |
          choco install inkscape nsis --no-progress -y
          echo "C:\Program Files\Inkscape\bin" >> $env:GITHUB_PATH

      # 5Ô∏è‚É£ Install Craft
      - name: Install Craft
        shell: pwsh
        run: |
          if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
            git clone -q --depth=1 https://invent.kde.org/packaging/craftmaster.git ${{ env.CRAFT_MASTER_LOCATION }}
          }

          function craft() {
              python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
              if($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          # Add official blueprints for Nextcloud
          craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
          craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"

      # 6Ô∏è‚É£ Compile Nextcloud Desktop
      - name: Compile and Package Nextcloud Desktop
        shell: pwsh
        run: |
          function craft() {
              python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" --config "${{ env.CRAFT_MASTER_CONFIG }}" --target ${{ env.CRAFT_TARGET }} -c $args
              if($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          # Build the client
          craft --src-dir ${{ github.workspace }} nextcloud-client
          craft --package nextcloud-client

      # 7Ô∏è‚É£ Upload the MSI Installer
      - name: Upload Nextcloud Desktop MSI
        uses: actions/upload-artifact@v4
        with:
          name: nextcloud-desktop-windows-msi
          path: ${{ env.CRAFT_ROOT }}\tmp\*.msi
