name: Build Nextcloud Desktop MSI (Windows)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_TARGET: ${{ github.workspace }}\windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini

    steps:
    # -------------------------------------------------
    # 1Ô∏è‚É£ Checkout source
    # -------------------------------------------------
    - name: Checkout source
      uses: actions/checkout@v4

    # -------------------------------------------------
    # 2Ô∏è‚É£ Setup Python 3.10
    # -------------------------------------------------
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # -------------------------------------------------
    # 3Ô∏è‚É£ Clone CraftMaster
    # -------------------------------------------------
    - name: Clone CraftMaster
      shell: powershell
      run: |
        if (!(Test-Path "$env:CRAFT_MASTER_LOCATION")) {
          git clone https://invent.kde.org/packaging/craftmaster.git `
            -b master `
            "$env:CRAFT_MASTER_LOCATION"
        }

    # -------------------------------------------------
    # 4Ô∏è‚É£ Create craftmaster.ini
    # -------------------------------------------------
    - name: Create craftmaster.ini
      shell: powershell
      run: |
        Set-Content `
          -Path "$env:CRAFT_MASTER_CONFIG" `
          -Value "[General]`nPlatform = windows`nABI = windows-msvc2022_64-cl" `
          -Encoding Ascii

    # -------------------------------------------------
    # 5Ô∏è‚É£ Clone Nextcloud Desktop Blueprints
    # -------------------------------------------------
    - name: Clone Nextcloud Desktop Blueprints
      shell: powershell
      run: |
        $bpTarget = "$env:CRAFT_TARGET\etc\blueprints\locations\desktop-client-blueprints"
        if (!(Test-Path $bpTarget)) {
          git clone https://github.com/nextcloud/desktop-client-blueprints.git $bpTarget
        }

    # -------------------------------------------------
    # 6Ô∏è‚É£ Install dependencies
    # -------------------------------------------------
    - name: Install dependencies
      shell: powershell
      run: |
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          -c --install-deps nextcloud-client

    # -------------------------------------------------
    # 7Ô∏è‚É£ Disable broken Inkscape blueprint
    # -------------------------------------------------
    - name: Disable Inkscape Blueprint
      shell: powershell
      run: |
        Remove-Item `
          "$env:CRAFT_TARGET\etc\blueprints\locations\desktop-client-blueprints\binary\_win\inkscape" `
          -Recurse -Force -ErrorAction SilentlyContinue

    # -------------------------------------------------
    # 8Ô∏è‚É£ Build Nextcloud Desktop
    # -------------------------------------------------
    - name: Build Nextcloud Desktop
      shell: powershell
      run: |
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          -c nextcloud-client

    # -------------------------------------------------
    # 9Ô∏è‚É£ Package MSI
    # -------------------------------------------------
    - name: Package MSI
      shell: powershell
      run: |
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          -c package nextcloud-client --options nextcloud-client.packageType=msi

    # -------------------------------------------------
    # üîü Upload MSI
    # -------------------------------------------------
    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: nextcloud-desktop-msi
        path: |
          ${{ env.CRAFT_TARGET }}\tmp\*.msi
