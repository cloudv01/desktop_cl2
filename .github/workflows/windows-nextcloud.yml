name: Build Branded Windows MSI Client

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_TARGET: windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
      CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

    steps:
      # -------------------------------------------------
      # 1. CHECKOUT
      # -------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. SETUP PYTHON
      # -------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # -------------------------------------------------
      # 3. INSTALL WiX
      # -------------------------------------------------
      - name: Install WiX
        shell: pwsh
        run: |
          choco install wixtoolset --no-progress -y

      # -------------------------------------------------
      # 4. INSTALL INKSCAPE (REQUIRED)
      # -------------------------------------------------
      - name: Install Inkscape
        shell: pwsh
        run: |
          choco install inkscape --no-progress -y

          $inkscapePath = "C:\Program Files\Inkscape\bin"
          if (Test-Path $inkscapePath) {
            echo "$inkscapePath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

          inkscape --version

      # -------------------------------------------------
      # 5. INSTALL CRAFT
      # -------------------------------------------------
      - name: Install Craft
        shell: pwsh
        run: |
          if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
            git clone --depth=1 `
              https://invent.kde.org/packaging/craftmaster.git `
              "${{ env.CRAFT_MASTER_LOCATION }}"
          }

          function craft {
            param([Parameter(ValueFromRemainingArguments=$true)]$Args)
            python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
              --config "${{ env.CRAFT_MASTER_CONFIG }}" `
              --target ${{ env.CRAFT_TARGET }} -c @Args
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
          craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"

          craft craft
          craft --install-deps nextcloud-client

      # -------------------------------------------------
      # 6. BUILD + PACKAGE MSI
      # -------------------------------------------------
      - name: Build MSI
        shell: pwsh
        run: |
          function craft {
            param([Parameter(ValueFromRemainingArguments=$true)]$Args)
            python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
              --config "${{ env.CRAFT_MASTER_CONFIG }}" `
              --target ${{ env.CRAFT_TARGET }} -c @Args
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          craft nextcloud-client
          craft package nextcloud-client --options nextcloud-client.packageType=msi

      # -------------------------------------------------
      # 7. UPLOAD MSI
      # -------------------------------------------------
      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: nextcloud-windows-msi
          path: ${{ env.CRAFT_ROOT }}\tmp\*.msi


# name: Build Branded Windows MSI Client

# on:
#   push:
#     branches: [ master, main ]
#   workflow_dispatch:

# jobs:
#   build:
#     runs-on: windows-2022

#     env:
#       CRAFT_TARGET: windows-msvc2022_64-cl
#       CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
#       CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
#       CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

#     steps:
#       # -------------------------------------------------
#       # 1. CHECKOUT
#       # -------------------------------------------------
#       - name: Checkout
#         uses: actions/checkout@v4

#       # -------------------------------------------------
#       # 2. SETUP PYTHON
#       # -------------------------------------------------
#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.12'

#       # -------------------------------------------------
#       # 3. INSTALL WiX
#       # -------------------------------------------------
#       - name: Install WiX
#         shell: pwsh
#         run: |
#           choco install wixtoolset --no-progress -y

#       # -------------------------------------------------
#       # 4. INSTALL CRAFT (CORRECT)
#       # -------------------------------------------------
#       - name: Install Craft
#         shell: pwsh
#         run: |
#           if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
#             git clone --depth=1 `
#               https://invent.kde.org/packaging/craftmaster.git `
#               "${{ env.CRAFT_MASTER_LOCATION }}"
#           }

#           function craft {
#             param([Parameter(ValueFromRemainingArguments=$true)]$Args)
#             python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
#               --config "${{ env.CRAFT_MASTER_CONFIG }}" `
#               --target ${{ env.CRAFT_TARGET }} -c @Args
#             if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
#           }

#           craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
#           craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"

#           craft craft
#           craft --install-deps nextcloud-client

#       # -------------------------------------------------
#       # 5. BUILD + PACKAGE MSI (CORRECT ORDER)
#       # -------------------------------------------------
#       - name: Build MSI
#         shell: pwsh
#         run: |
#           function craft {
#             param([Parameter(ValueFromRemainingArguments=$true)]$Args)
#             python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
#               --config "${{ env.CRAFT_MASTER_CONFIG }}" `
#               --target ${{ env.CRAFT_TARGET }} -c @Args
#             if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
#           }

#           craft nextcloud-client
#           craft package nextcloud-client --options nextcloud-client.packageType=msi

#       # -------------------------------------------------
#       # 6. UPLOAD MSI
#       # -------------------------------------------------
#       - name: Upload MSI
#         uses: actions/upload-artifact@v4
#         with:
#           name: nextcloud-windows-msi
#           path: ${{ env.CRAFT_ROOT }}\tmp\*.msi
