name: Build Nextcloud Desktop MSI (Windows)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_TARGET: windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini

    steps:
    # -------------------------------------------------
    # 1Ô∏è‚É£ Checkout source
    # -------------------------------------------------
    - name: Checkout source
      uses: actions/checkout@v4

    # -------------------------------------------------
    # 2Ô∏è‚É£ Setup Python 3.10 (Craft incompatible with 3.12)
    # -------------------------------------------------
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # -------------------------------------------------
    # 3Ô∏è‚É£ Clone CraftMaster
    # -------------------------------------------------
    - name: Clone CraftMaster
      shell: powershell
      run: |
        if (!(Test-Path "$env:CRAFT_MASTER_LOCATION")) {
          git clone https://invent.kde.org/packaging/craftmaster.git `
            -b master `
            "$env:CRAFT_MASTER_LOCATION"
        }

    # -------------------------------------------------
    # 4Ô∏è‚É£ Create craftmaster.ini (ASCII / no BOM)
    # -------------------------------------------------
    - name: Create craftmaster.ini
      shell: powershell
      run: |
        Set-Content `
          -Path "$env:CRAFT_MASTER_CONFIG" `
          -Value "[General]`nPlatform = windows`nABI = windows-msvc2022_64-cl" `
          -Encoding Ascii

    # -------------------------------------------------
    # 5Ô∏è‚É£ Bootstrap Craft (register basic paths)
    # -------------------------------------------------
    - name: Bootstrap Craft
      shell: powershell
      run: |
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          craft

    # -------------------------------------------------
    # 6Ô∏è‚É£ Add Blueprints (needed for Windows target)
    # -------------------------------------------------
    - name: Add Craft Blueprints
      shell: powershell
      run: |
        $env:PATH="$env:CRAFT_TARGET\craft\bin;$env:PATH"

        craft --add-blueprint-repository `
          https://invent.kde.org/packaging/craft-blueprints-kde.git

        craft --add-blueprint-repository `
          https://github.com/nextcloud/desktop-client-blueprints.git

    # -------------------------------------------------
    # 7Ô∏è‚É£ Fast-Fail Dependency Check (‚ùå Catch errors early)
    # -------------------------------------------------
    - name: Check Targets & Dependencies (Fast-Fail)
      shell: powershell
      run: |
        $env:PATH="$env:CRAFT_TARGET\craft\bin;$env:PATH"
        # No build, just resolve dependencies and targets
        craft nextcloud-client -n
        # Also install dependencies (fails fast if missing)
        craft --install-deps nextcloud-client

    # -------------------------------------------------
    # 8Ô∏è‚É£ Disable broken Inkscape blueprint
    # -------------------------------------------------
    - name: Disable Inkscape Blueprint
      shell: powershell
      run: |
        Remove-Item `
          "$env:CRAFT_TARGET\etc\blueprints\locations\desktop-client-blueprints\binary\_win\inkscape" `
          -Recurse -Force -ErrorAction SilentlyContinue

    # -------------------------------------------------
    # 9Ô∏è‚É£ Update Craft (register targets)
    # -------------------------------------------------
    - name: Update Craft
      shell: powershell
      run: |
        $env:PATH="$env:CRAFT_TARGET\craft\bin;$env:PATH"
        craft --update

    # -------------------------------------------------
    # üîü Build Nextcloud Desktop
    # -------------------------------------------------
    - name: Build Nextcloud Desktop
      shell: powershell
      run: |
        $env:PATH="$env:CRAFT_TARGET\craft\bin;$env:PATH"
        craft nextcloud-client

    # -------------------------------------------------
    # 1Ô∏è‚É£1Ô∏è‚É£ Package MSI
    # -------------------------------------------------
    - name: Package MSI
      shell: powershell
      run: |
        $env:PATH="$env:CRAFT_TARGET\craft\bin;$env:PATH"
        craft package nextcloud-client --options nextcloud-client.packageType=msi

    # -------------------------------------------------
    # 1Ô∏è‚É£2Ô∏è‚É£ Upload MSI Artifact
    # -------------------------------------------------
    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: nextcloud-desktop-msi
        path: |
          ${{ env.CRAFT_TARGET }}\tmp\*.msi
