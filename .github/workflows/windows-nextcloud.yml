name: Build Branded Windows MSI Client

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_TARGET: windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
      CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Craft
        uses: actions/cache@v4
        with:
          path: ${{ env.CRAFT_ROOT }}
          key: windows-craft-stable-4.0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install WiX (Inkscape comes from Craft)
        shell: pwsh
        run: |
          choco install wixtoolset --no-progress -y

      - name: Install Craft (stable-4.0)
        shell: pwsh
        run: |
          if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
            git clone --branch stable-4.0 --depth=1 `
              https://invent.kde.org/packaging/craftmaster.git `
              "${{ env.CRAFT_MASTER_LOCATION }}"
          }

          function craft {
            param([Parameter(ValueFromRemainingArguments=$true)]$Args)
            python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
              --config "${{ env.CRAFT_MASTER_CONFIG }}" `
              --target ${{ env.CRAFT_TARGET }} -c @Args
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
          craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"

          craft craft
          craft --install-deps nextcloud-client

      - name: Build & Package MSI
        shell: pwsh
        run: |
          function craft {
            param([Parameter(ValueFromRemainingArguments=$true)]$Args)
            python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
              --config "${{ env.CRAFT_MASTER_CONFIG }}" `
              --target ${{ env.CRAFT_TARGET }} -c @Args
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          craft nextcloud-client
          craft package nextcloud-client --options nextcloud-client.packageType=msi

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: nextcloud-windows-msi
          path: ${{ env.CRAFT_ROOT }}\tmp\*.msi
