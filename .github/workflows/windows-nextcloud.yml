name: Build Nextcloud Desktop MSI (Windows)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_TARGET: windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
      CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # ⚠️ Craft DOES NOT WORK with Python 3.12
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Clone CraftMaster
      shell: powershell
      run: |
        if (!(Test-Path "$env:CRAFT_MASTER_LOCATION")) {
          git clone https://invent.kde.org/packaging/craftmaster.git `
            -b master `
            "$env:CRAFT_MASTER_LOCATION"
        }

    - name: Create craftmaster.ini (ASCII to avoid BOM)
      shell: powershell
      run: |
        Set-Content `
          -Path "$env:CRAFT_MASTER_CONFIG" `
          -Value "[General]`nABI = windows-msvc2022_64-cl" `
          -Encoding ascii

    # -------------------------
    # Bootstrap Craft
    # -------------------------
    - name: Bootstrap Craft
      shell: powershell
      run: |
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          -c nextcloud-client

    # -------------------------
    # Fix Inkscape crash (remove blueprint)
    # -------------------------
    - name: Disable Inkscape Blueprint
      shell: powershell
      run: |
        Remove-Item `
          "$env:CRAFT_ROOT\etc\blueprints\locations\desktop-client-blueprints\binary\_win\inkscape" `
          -Recurse -Force -ErrorAction SilentlyContinue

    # -------------------------
    # Update Craft
    # -------------------------
    - name: Update Craft
      shell: powershell
      run: |
        $env:Path="$env:CRAFT_ROOT\craft\bin;$env:Path"
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          -c nextcloud-client --update

    # -------------------------
    # Install dependencies
    # -------------------------
    - name: Install Nextcloud dependencies
      shell: powershell
      run: |
        $env:Path="$env:CRAFT_ROOT\craft\bin;$env:Path"
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          -c nextcloud-client --install-deps

    # -------------------------
    # Build Nextcloud Desktop
    # -------------------------
    - name: Build Nextcloud Desktop
      shell: powershell
      run: |
        $env:Path="$env:CRAFT_ROOT\craft\bin;$env:Path"
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          -c nextcloud-client

    # -------------------------
    # Package MSI
    # -------------------------
    - name: Package MSI
      shell: powershell
      run: |
        $env:Path="$env:CRAFT_ROOT\craft\bin;$env:Path"
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          -c nextcloud-client --options nextcloud-client.packageType=msi

    # -------------------------
    # Upload MSI artifact
    # -------------------------
    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: nextcloud-desktop-msi
        path: ${{ env:CRAFT_ROOT }}\tmp\*.msi
