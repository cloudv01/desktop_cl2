name: Build Nextcloud Desktop MSI (Windows)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_TARGET: windows-msvc2019_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
      CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2019_64-cl

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Visual Studio Build Tools + Ninja
      shell: powershell
      run: |
        choco install visualstudio2019buildtools --includeRecommended --includeOptional -y
        choco install ninja -y

    - name: Clone CraftMaster
      shell: powershell
      run: |
        if (!(Test-Path "$env:CRAFT_MASTER_LOCATION")) {
          git clone https://invent.kde.org/packaging/craftmaster.git `
            -b master `
            "$env:CRAFT_MASTER_LOCATION"
        }

    - name: Create craftmaster.ini
      shell: powershell
      run: |
        Set-Content `
          -Path "$env:CRAFT_MASTER_CONFIG" `
          -Value "[General]`nABI = windows-msvc2019_64-cl" `
          -Encoding Ascii

    # ðŸ”Ž FAIL FAST â€“ shows targets immediately
    - name: Print available Craft targets
      shell: powershell
      run: |
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          --print-targets

    - name: Bootstrap Craft
      shell: powershell
      run: |
        python "$env:CRAFT_MASTER_LOCATION\CraftMaster.py" `
          --config "$env:CRAFT_MASTER_CONFIG" `
          --setup

    # ðŸ”¥ Prevent SVG / Inkscape crash
    - name: Disable Inkscape Blueprint
      shell: powershell
      run: |
        Remove-Item `
          "$env:CRAFT_ROOT\etc\blueprints\locations\desktop-client-blueprints\binary\_win\inkscape" `
          -Recurse -Force -ErrorAction SilentlyContinue

    - name: Build Nextcloud Desktop
      shell: powershell
      run: |
        $env:PATH="$env:CRAFT_ROOT\craft\bin;$env:PATH"
        craft nextcloud-client

    - name: Package MSI
      shell: powershell
      run: |
        $env:PATH="$env:CRAFT_ROOT\craft\bin;$env:PATH"
        craft package nextcloud-client --options nextcloud-client.packageType=msi

    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: nextcloud-desktop-msi
        path: |
          ${{ env.CRAFT_ROOT }}\tmp\*.msi
