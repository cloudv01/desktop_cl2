name: Build Branded Windows MSI Client

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_TARGET: windows-msvc2022_64-cl
      CRAFT_MASTER_LOCATION: ${{ github.workspace }}\CraftMaster
      CRAFT_MASTER_CONFIG: ${{ github.workspace }}\craftmaster.ini
      CRAFT_ROOT: ${{ github.workspace }}\windows-msvc2022_64-cl
      CRAFT_USE_SYSTEM_LIBS: "False"

    steps:
      # -------------------------------------------------
      # 1. CHECKOUT
      # -------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------
      # 2. CACHE CRAFT
      # -------------------------------------------------
      - name: Cache Craft
        uses: actions/cache@v4
        with:
          path: ${{ env.CRAFT_ROOT }}
          key: windows-craft-v3
          restore-keys: |
            windows-craft-

      # -------------------------------------------------
      # 3. PYTHON
      # -------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # -------------------------------------------------
      # 4. INSTALL WiX ONLY (NO INKSCAPE)
      # -------------------------------------------------
      - name: Install WiX
        shell: pwsh
        run: |
          choco install wixtoolset --no-progress -y

      # -------------------------------------------------
      # 5. INSTALL CRAFT
      # -------------------------------------------------
      - name: Install Craft
        shell: pwsh
        run: |
          if (!(Test-Path "${{ env.CRAFT_MASTER_LOCATION }}")) {
            git clone --depth=1 https://invent.kde.org/packaging/craftmaster.git `
              "${{ env.CRAFT_MASTER_LOCATION }}"
          }

          function craft {
            param([Parameter(ValueFromRemainingArguments=$true)]$Args)
            python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
              --config "${{ env.CRAFT_MASTER_CONFIG }}" `
              --target ${{ env.CRAFT_TARGET }} -c @Args
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          craft --add-blueprint-repository "https://github.com/nextcloud/craft-blueprints-kde.git|stable-4.0|"
          craft --add-blueprint-repository "https://github.com/nextcloud/desktop-client-blueprints.git|stable-4.0|"
          craft craft
          craft --install-deps nextcloud-client

      # -------------------------------------------------
      # 6. PATCH + BRANDING
      # -------------------------------------------------
      - name: Patch Blueprint and Branding
        shell: pwsh
        run: |
          $bp = "${{ env.CRAFT_ROOT }}\etc\blueprints\locations\desktop-client-blueprints\nextcloud-client\nextcloud-client.py"
          if (Test-Path $bp) {
            $content = Get-Content $bp -Raw
            if ($content -notmatch "import os") {
              "import os`r`n$content" | Set-Content $bp
            }
          }

          if (!(Test-Path "theme")) {
            New-Item -ItemType Directory -Path theme | Out-Null
          }

          $file = "theme\nextcloud.VisualElementsManifest.xml"
          if (Test-Path $file) { Remove-Item $file }

          Add-Content $file '<Application xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'
          Add-Content $file '  <VisualElements'
          Add-Content $file '    ShowNameOnSquare150x150Logo="on"'
          Add-Content $file '    Square150x150Logo="visualelements\150-nextcloud-icon.png"'
          Add-Content $file '    Square70x70Logo="visualelements\70-nextcloud-icon.png"'
          Add-Content $file '    ForegroundText="light"'
          Add-Content $file '    BackgroundColor="#0082c9"/>'
          Add-Content $file '</Application>'

      # -------------------------------------------------
      # 7. BUILD + PACKAGE (MSI)
      # -------------------------------------------------
      - name: Build MSI
        shell: pwsh
        run: |
          function craft {
            param([Parameter(ValueFromRemainingArguments=$true)]$Args)
            python "${{ env.CRAFT_MASTER_LOCATION }}\CraftMaster.py" `
              --config "${{ env.CRAFT_MASTER_CONFIG }}" `
              --target ${{ env.CRAFT_TARGET }} -c @Args
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          }

          craft nextcloud-client
          craft package nextcloud-client --package-type msi

      # -------------------------------------------------
      # 8. UPLOAD MSI
      # -------------------------------------------------
      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: nextcloud-Windows-MSI
          path: |
            ${{ env.CRAFT_ROOT }}\tmp\*.msi
