name: Build Nextcloud Desktop MSI (Windows)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    env:
      CRAFT_ROOT: C:\CraftRoot

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # Python (required by Craft)
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # Install Visual Studio Build Tools (C++ Desktop)
    - name: Install Visual Studio Build Tools
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    # Install KDE Craft (official installer)
    - name: Install KDE Craft
      shell: powershell
      run: |
        Invoke-WebRequest `
          -Uri https://binary-factory.kde.org/job/Craft_Nightly_Windows/lastSuccessfulBuild/artifact/CraftInstaller.exe `
          -OutFile CraftInstaller.exe

        Start-Process `
          -FilePath .\CraftInstaller.exe `
          -ArgumentList "/S /D=$env:CRAFT_ROOT" `
          -Wait

    # Load Craft environment
    - name: Load Craft Environment
      shell: powershell
      run: |
        & "$env:CRAFT_ROOT\craft\craftenv.ps1"
        craft --version

    # Add Nextcloud desktop blueprints
    - name: Add Nextcloud Blueprints
      shell: powershell
      run: |
        & "$env:CRAFT_ROOT\craft\craftenv.ps1"
        craft --add-blueprint-repository https://github.com/nextcloud/desktop-client-blueprints.git

    # Install dependencies
    - name: Install Dependencies
      shell: powershell
      run: |
        & "$env:CRAFT_ROOT\craft\craftenv.ps1"
        craft --install-deps nextcloud-client

    # Build Nextcloud Desktop
    - name: Build Nextcloud Desktop
      shell: powershell
      run: |
        & "$env:CRAFT_ROOT\craft\craftenv.ps1"
        craft nextcloud-client

    # Package MSI
    - name: Package MSI
      shell: powershell
      run: |
        & "$env:CRAFT_ROOT\craft\craftenv.ps1"
        craft package nextcloud-client

    # Upload MSI
    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: nextcloud-desktop-msi
        path: C:\CraftRoot\packages\*.msi
